<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trainer Admin - Fitness Tracker</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
</head>
<body>
  <script src="js/navbar.js"></script>
  <div class="container" style="margin-top:90px;">
    <div class="d-flex align-items-center mb-3">
      <h4 class="me-auto">Trainer Approvals</h4>
      <span class="badge bg-secondary" id="trainerRoleBadge" style="display:none;">Trainer</span>
    </div>
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">Create Challenge</h5>
        <form id="createForm" class="row g-2">
          <div class="col-md-6"><input class="form-control" id="title" placeholder="Title" required></div>
          <div class="col-md-6">
            <select id="type" class="form-select">
              <option value="steps">Steps</option>
              <option value="workouts">Workouts</option>
              <option value="distance">Distance</option>
              <option value="calories">Calories</option>
              <option value="active_minutes">Active Minutes</option>
            </select>
          </div>
          <div class="col-md-6"><input type="number" min="1" class="form-control" id="target" placeholder="Target" required></div>
          <div class="col-md-3"><input type="date" class="form-control" id="start" required></div>
          <div class="col-md-3"><input type="date" class="form-control" id="end" required></div>
          <div class="col-12"><textarea class="form-control" id="desc" placeholder="Description" rows="2"></textarea></div>
          <div class="col-12"><button class="btn btn-primary" type="submit">Create</button></div>
        </form>
      </div>
    </div>
    <div class="alert alert-warning" id="notTrainer" style="display:none;">
      You must be logged in as a trainer to view this page.
    </div>
    <div id="approvalsContainer" class="row g-3"></div>
  </div>
  <script>
    const API = 'http://localhost:5000/api';
    const token = localStorage.getItem('token');
    const role = localStorage.getItem('role');
    const approvalsContainer = document.getElementById('approvalsContainer');
    const notTrainer = document.getElementById('notTrainer');
    const badge = document.getElementById('trainerRoleBadge');

    document.addEventListener('DOMContentLoaded', async () => {
      if (role !== 'trainer') {
        notTrainer.style.display = 'block';
        return;
      }
      badge.style.display = 'inline-block';
      document.getElementById('createForm').addEventListener('submit', createChallenge);
      await loadApprovals();
    });

    async function loadApprovals() {
      approvalsContainer.innerHTML = '<div class="col-12 text-muted">Loadingâ€¦</div>';
      try {
        const res = await fetch(`${API}/challenges`, { headers: { 'Authorization': `Bearer ${token}` } });
        const json = await res.json();
        const challenges = json.data || [];
        const pending = [];
        challenges.forEach(ch => {
          (ch.participants || []).forEach(p => {
            const isCompleted = !!p.completed;
            const notApproved = !p.approvedByTrainer;
            if (isCompleted && notApproved && String(ch.createdBy?._id||ch.createdBy) === localStorage.getItem('userId')) {
              pending.push({ ch, p });
            }
          });
        });
        if (pending.length === 0) {
          approvalsContainer.innerHTML = '<div class="col-12 text-muted">No pending approvals.</div>';
          return;
        }
        approvalsContainer.innerHTML = pending.map(({ ch, p }) => `
          <div class="col-md-6">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">${ch.title}</h5>
                <p class="card-text mb-1"><strong>User:</strong> ${p.user?.username || p.user}</p>
                <p class="card-text mb-2"><strong>Progress:</strong> ${p.progress} / ${ch.targetValue}</p>
                <button class="btn btn-success btn-sm" onclick="approve('${ch._id}','${p._id || p.user}')">
                  <i class="fas fa-check me-1"></i>Approve
                </button>
                <button class="btn btn-outline-primary btn-sm ms-2" onclick="declareWinner('${ch._id}','${p.user?._id || p.user}')">
                  <i class="fas fa-trophy me-1"></i>Winner
                </button>
              </div>
            </div>
          </div>
        `).join('');
      } catch (e) {
        approvalsContainer.innerHTML = '<div class="col-12 text-danger">Failed to load.</div>';
      }
    }

    async function createChallenge(e){
      e.preventDefault();
      const payload = {
        title: document.getElementById('title').value.trim(),
        description: document.getElementById('desc').value.trim(),
        challengeType: document.getElementById('type').value,
        targetValue: Number(document.getElementById('target').value),
        startDate: new Date(document.getElementById('start').value).toISOString(),
        endDate: new Date(document.getElementById('end').value).toISOString(),
        isPublic: true
      };
      const res = await fetch(`${API}/challenges`, { method:'POST', headers:{ 'Authorization':`Bearer ${token}`, 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
      if (res.ok) {
        (e.target).reset();
        loadApprovals();
      }
    }

    window.declareWinner = async function(chId, userId){
      const message = prompt('Winner message:', 'Great job! You are the winner!');
      if (message === null) return;
      const res = await fetch(`${API}/challenges/${chId}/winner`, { method:'POST', headers:{ 'Authorization':`Bearer ${token}`, 'Content-Type':'application/json' }, body: JSON.stringify({ winnerUserId: userId, message }) });
      if (res.ok) {
        alert('Winner announced and notified.');
        loadApprovals();
      }
    }

    async function approve(challengeId, participantId) {
      try {
        const res = await fetch(`${API}/challenges/${challengeId}/approve/${participantId}`, { method: 'PUT', headers: { 'Authorization': `Bearer ${token}` } });
        if (res.ok) {
          await loadApprovals();
        }
      } catch {}
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
